<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="data:image/gif;base64,R0lGODlhEAAQAIABAP8AAP///yH5BAEAAAEALAAAAAAQABAAAAIgjI+py+0PTgygTolpNvN6FF1alZBeB2bf1lnPC8fybBQAOw==" type="image/gif">
  <title>æ‰¹é‡å›¾ç‰‡å‹ç¼©å™¨</title>
  <style>
    :root {
      --bg-light: #fff;
      --text-light: #000;
      --bg-dark: #121212;
      --text-dark: #f0f0f0;
      --primary-color: #007bff;
      --primary-hover: #0069d9;
      --border: #ccc;
      --border-dark: #444;
    }

    html[data-theme='dark'] { background-color: var(--bg-dark); color: var(--text-dark); }
    html[data-theme='light'] { background-color: var(--bg-light); color: var(--text-light); }

    body { font-family: sans-serif; padding: 2em; max-width: 1440px; margin: auto; transition: background .3s, color .3s; }

    #dropZone { border: 2px dashed var(--border); padding: 1.5em; text-align: center; margin: 1em 0; border-radius: 10px; background: #f9f9f9; cursor: pointer; transition: background-color .3s, border-color .3s; }
    html[data-theme='dark'] #dropZone { background: #1f1f1f; border-color: var(--border-dark); }
    #dropZone.dragover, #dropZone:hover { background-color: #e0f7ff; border-color: var(--primary-color); }
    html[data-theme='dark'] #dropZone.dragover, html[data-theme='dark'] #dropZone:hover { background-color: #2a3a4a; border-color: var(--primary-color); }

    .toolbar { display: flex; gap: .75em; align-items: center; flex-wrap: wrap; }
    .toolbar button, .toolbar input[type="number"], .toolbar label { font-size: 14px; }
    .btn { padding: .6em 1em; border: 1px solid var(--border); border-radius: 8px; background: transparent; cursor: pointer; }
    .btn.primary { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
    .btn.primary:hover { background: var(--primary-hover); }
    .btn.warning { background: #f44336; color: #fff; border-color: #f44336; }
    .btn.warning:hover { background: #e53935; }

    #themeToggle { background: none; border: none; font-size: 1.2em; cursor: pointer; color: inherit; }

    .input-group { display: flex; align-items: center; gap: .5em; }
    .input-group input[type="number"] { width: 7em; padding: .45em; border: 1px solid var(--border); border-radius: 6px; }
    html[data-theme='dark'] .input-group input[type="number"] { background: #2a2a2a; border-color: var(--border-dark); color: var(--text-dark); }

    .log { margin-top: 1em; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    html[data-theme='dark'] .log { border-color: var(--border-dark); }
    .log-header { padding: .7em 1em; font-weight: bold; background: rgba(0,0,0,.05); }
    html[data-theme='dark'] .log-header { background: rgba(255,255,255,.06); }
    .log-body { overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; max-height: 50vh; }
    .log-row { display: grid; grid-template-columns: 2fr .6fr .6fr .6fr 1.5fr; gap: .5em; padding: .6em 1em; border-top: 1px dashed var(--border); align-items: center; word-break: break-all; }
    html[data-theme='dark'] .log-row { border-color: var(--border-dark); }
    .log-row.header { font-weight: 600; position: sticky; top: 0; background: inherit; border-top: none; }
    .badge { padding: .15em .5em; border-radius: 999px; font-weight: 700; font-size: 12px; display: inline-block; }
    .ok { background: #e7f8ec; color: #0a7a32; }
    .skip { background: #fff6e5; color: #915e00; }
    .err { background: #ffe8e6; color: #982222; }

    .file-link { color: inherit; text-decoration: underline dotted; cursor: zoom-in; }

    /* ç»“æœé¢„è§ˆå°å›¾ï¼ˆè·Ÿéšé¼ æ ‡ï¼‰ */
    #imgPreview {
      position: fixed;
      top: 0; left: 0;
      transform: translate(-9999px, -9999px);
      background: var(--bg-light);
      border-radius: 8px;
      padding: 6px;
      z-index: 1500;
      pointer-events: none;
      box-shadow: 0 4px 18px rgba(0,0,0,.15);
    }
    html[data-theme='dark'] #imgPreview {
      background: var(--bg-dark);
      border: 1px solid var(--primary-color);
    }
    #imgPreview img { max-width: 180px; max-height: 180px; display: block; }

/* å¤§å›¾å¼¹çª— */
.image-modal-overlay {
  position: fixed; 
  inset: 0;
  background: rgba(0,0,0,.45);
  display: flex;
  align-items: center; 
  justify-content: center;
  z-index: 2000;
  /* åˆå§‹çŠ¶æ€ï¼šå®Œå…¨é€æ˜ä¸”ä¸å¯è§ */
  opacity: 0;
  visibility: hidden;
  transition: opacity .3s ease, visibility .3s ease;
}

/* å½“æ·»åŠ  .show ç±»æ—¶ï¼Œå¼¹çª—å˜å¾—å¯è§ä¸”ä¸é€æ˜ */
.image-modal-overlay.show { 
  opacity: 1; 
  visibility: visible; 
}

.image-modal {
  background: var(--bg-light);
  border-radius: 12px;
  padding: 12px;
  max-width: 90vw;
  max-height: 90vh;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  /* é»˜è®¤çš„è¾¹æ¡†æ ·å¼ï¼Œä½¿ç”¨é€šç”¨è¾¹æ¡†é¢œè‰² */
  border: 1px solid var(--border);
}

html[data-theme='dark'] .image-modal {
  /* æ·±è‰²æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰²å’Œè¾¹æ¡†è‰² */
  background: #222;
  border-color: var(--primary-color);
}
    .image-modal img { max-width: 86vw; max-height: 80vh; display: block; border-radius: 8px; }
    .image-modal .modal-bar { display:flex; align-items:center; justify-content:space-between; gap:1em; margin-bottom:8px; }
    .image-modal .modal-bar .name { font-weight:600; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:70vw; }
    .image-modal .close { border:none; background:transparent; font-size:22px; cursor:pointer; line-height:1; color: inherit; }

    /* è‡ªå®šä¹‰ç¡®è®¤å¼¹çª—ï¼ˆä¿ç•™åŸæœ‰æ ·å¼ï¼‰ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: none;
      align-items: center; justify-content: center;
      z-index: 2000; opacity: 0; transition: opacity .2s ease-in-out;
    }
    .modal-overlay.show { display: flex; opacity: 1; }
    .modal-content {
      background: var(--bg-light);
      padding: 2em; border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      max-width: 450px; width: 90%; text-align: center;
      transform: scale(0.95); transition: transform .2s ease-in-out;
    }
    .modal-overlay.show .modal-content { transform: scale(1); }
    html[data-theme='dark'] .modal-content { background: #282828; }
    .modal-content p { margin: 0 0 1.5em; font-size: 16px; line-height: 1.6; white-space: pre-wrap; }
    .modal-buttons { display: flex; gap: 1em; justify-content: center; }

    .toast {
      position: fixed; top: 20px; left: 50%;
      transform: translateX(-50%) translateY(-10px);
      background: #333; color: #fff;
      padding: 12px 16px; border-radius: 8px;
      z-index: 1000; opacity: 0; pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
    @keyframes fadeInDown { from{opacity:0; transform:translate(-50%,-10px);} to{opacity:1; transform:translate(-50%,0);} }
    .toast.show { animation: fadeInDown .25s; }
    .toast.hide { opacity:0; transform:translate(-50%,-10px); }
  </style>
</head>
<body>
  <header style="display:flex;align-items:center;justify-content:space-between;gap:1em;flex-wrap:wrap;">
    <h2>ğŸ“¦ å›¾ç‰‡å‹ç¼©å™¨</h2>
    <button id="themeToggle" title="æ·±æµ…è‰²åˆ‡æ¢">ğŸŒ“</button>
  </header>

  <div class="toolbar">
    <button class="btn primary" id="chooseDirBtn" style="display:none;">é€‰æ‹©æ–‡ä»¶å¤¹å¹¶å‹ç¼©</button>

    <label class="input-group" style="gap:.4em">
      <input type="checkbox" id="forceUseDefault" /> æ‰‹åŠ¨è®¾ç½®
    </label>
    <div id="defaultSizeGroup" class="input-group" style="display:none">
      <label for="defaultSizeInput">ç›®æ ‡ï¼ˆKBï¼‰ï¼š</label>
      <input type="number" id="defaultSizeInput" value="160" min="1" />
    </div>

    <div class="input-group">
      <span>å¿«é€Ÿç›®æ ‡ï¼š</span>
      <button class="btn primary" data-preset="300">300KB</button>
      <button class="btn primary" data-preset="500">500KB</button>
      <button class="btn primary" data-preset="1000">1000KB</button>
    </div>

    <label class="input-group" style="gap:.4em">
      <input type="checkbox" id="pngToJpgCheckbox" /> PNGä¼˜å…ˆè½¬ä¸ºé«˜è´¨é‡JPGå†å‹ç¼©
    </label>

    <label class="input-group" style="gap:.4em">
      <input type="checkbox" id="removeParamCheckbox" /> åˆ é™¤æ–‡ä»¶åä¸­çš„å‚æ•°
    </label>
  </div>

  <p style="margin:.6em 0 .2em">æ‹–å…¥ <strong>æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</strong> å¼€å§‹ã€‚æ–‡ä»¶åå¯åŒ…å«å¤§å°å‚æ•°ï¼Œå¦‚ <code>xxx-160KB.jpg</code>ã€‚</p>
  <div id="dropZone">ğŸ“‚ ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–å°† <strong>æ–‡ä»¶å¤¹</strong> æ‹–æ‹½åˆ°æ­¤åŒºåŸŸ</div>
  <input type="file" id="fileInput" accept="image/*" multiple style="display:none" />

  <section class="log">
    <div class="log-header">å¤„ç†æ—¥å¿—</div>
    <div class="log-body" id="logBody"></div>
  </section>

  <div id="imgPreview"><img alt=""></div>

  <div class="image-modal-overlay" id="imgModal">
    <div class="image-modal">
      <div class="modal-bar">
        <div class="name" id="imgModalName"></div>
        <button class="close" id="imgModalClose" title="å…³é—­">âœ•</button>
      </div>
      <img id="imgModalImg" alt="">
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script>
    const APP_VERSION = '1.2.0';

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const chooseDirBtn = document.getElementById('chooseDirBtn');
    const defaultSizeInput = document.getElementById('defaultSizeInput');
    const forceUseDefault = document.getElementById('forceUseDefault');
    const defaultSizeGroup = document.getElementById('defaultSizeGroup');
    const themeToggle = document.getElementById('themeToggle');
    const removeParamCheckbox = document.getElementById('removeParamCheckbox');
    const pngToJpgCheckbox = document.getElementById('pngToJpgCheckbox');
    const logBody = document.getElementById('logBody');
    const toast = document.getElementById('toast');
    const imgPreview = document.getElementById('imgPreview');
    const imgPreviewImg = imgPreview.querySelector('img');
    const imgModal = document.getElementById('imgModal');
    const imgModalImg = document.getElementById('imgModalImg');
    const imgModalName = document.getElementById('imgModalName');
    const imgModalClose = document.getElementById('imgModalClose');

    const zip = new JSZip();

    // ç”¨äºç®¡ç†é¢„è§ˆURLï¼Œé¿å…å†…å­˜æ³„æ¼
    let currentPreviewURLs = [];
    function resetLog() {
      // å›æ”¶æ—§çš„ objectURL
      currentPreviewURLs.forEach(url => URL.revokeObjectURL(url));
      currentPreviewURLs = [];
      // é‡ç½®æ—¥å¿—ï¼Œä»…æœ‰è¡¨å¤´ï¼ˆä¿®å¤â€œè¡¨å¤´é‡å¤åœ¨åº•éƒ¨â€çš„é—®é¢˜ï¼‰
      logBody.innerHTML = `
        <div class="log-row header">
          <div>æ–‡ä»¶</div><div>åŸå¤§å°</div><div>ç›®æ ‡</div><div>ç»“æœ</div><div>è¯´æ˜</div>
        </div>`;
    }
    resetLog();

    // å…¼å®¹æ€§æ£€æŸ¥ + æ˜¾ç¤º/éšè—æŒ‰é’®
    window.addEventListener('DOMContentLoaded', () => {
      if (!('showDirectoryPicker' in window)) {
        const modalText = document.getElementById('modalText');
        modalText.textContent = 'âš ï¸å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶ç›´æ¥ä¿®æ”¹âš ï¸\nâœ…ï¸å°†ä½¿ç”¨æ–‡ä»¶æ‹–æ‹½æ‰“åŒ…ä¸ºZIPä¸‹è½½âœ…ï¸\næ¨èä½¿ç”¨Chrome/Edgeæµè§ˆå™¨ã€‚';
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        modalConfirmBtn.style = 'display:none';
        modalCancelBtn.textContent = 'ç»§ç»­ä½¿ç”¨æ‰“åŒ…æ¨¡å¼å¤„ç†å›¾ç‰‡';
        const modal = document.getElementById('modalOverlay');
        modal.classList.add('show');
        modalCancelBtn.addEventListener('click', () => modal.classList.remove('show'));
      } else {
        // chooseDirBtn.style.display = 'inline-block'; // å¦‚éœ€å¯ç”¨ç›®å½•å†™å›ï¼Œå¯æ”¾å¼€
      }
    });

    function showToast(msg, ms = 5000){
      toast.textContent = msg;
      toast.classList.add('show');
      toast.style.transform = 'translateX(-50%) translateY(0)';
      setTimeout(()=>{
        toast.classList.remove('show');
        toast.style.transform = 'translateX(-50%) translateY(-10px)';
      }, ms);
    }

    // è‡ªå®šä¹‰ç¡®è®¤å¼¹çª—
    function showCustomConfirm(message) {
      return new Promise(resolve => {
        const overlay = document.getElementById('modalOverlay');
        const textEl = document.getElementById('modalText');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');

        textEl.textContent = message;
        overlay.classList.add('show');

        const cleanup = () => {
          overlay.classList.remove('show');
          confirmBtn.replaceWith(confirmBtn.cloneNode(true));
          cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        };

        document.getElementById('modalConfirmBtn').addEventListener('click', () => { cleanup(); resolve(true); });
        document.getElementById('modalCancelBtn').addEventListener('click', () => { cleanup(); resolve(false); });
      });
    }

    function updateDefaultSizeVisibility(){ defaultSizeGroup.style.display = forceUseDefault.checked ? 'flex' : 'none'; }
    forceUseDefault.addEventListener('change', updateDefaultSizeVisibility);
    updateDefaultSizeVisibility();

    // é¢„è®¾æŒ‰é’®
    document.querySelectorAll('[data-preset]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        forceUseDefault.checked = true;
        updateDefaultSizeVisibility();
        defaultSizeInput.value = btn.dataset.preset;
        showToast(`å·²è®¾ç½®ç›®æ ‡ä¸º ${btn.dataset.preset}KBï¼Œå¹¶å¯ç”¨æ‰‹åŠ¨è®¾ç½®`);
      });
    });

    function formatKB(n){ return (n/1000).toFixed(1) + 'KB'; } // 1000 è¿›åˆ¶
    function ext(name){ return name.split('.').pop().toLowerCase(); }
    function isImageName(name){ return /\.(jpe?g|png|webp)$/i.test(name); }
    function getTargetSizeFromName(name){
      const fallback = parseInt(defaultSizeInput.value);
      const force = forceUseDefault.checked;
      if (force) return Math.max(1, fallback) * 1000;
      const m = name.match(/-(\d+)KB/i);
      if (m) return parseInt(m[1]) * 1000;
      return Math.max(1, fallback) * 1000;
    }
    function getCleanFileName(name){ return name.replace(/-\d+KB(?=\.[^.]+$)/i, ''); }
    function replaceExt(name, newExt){ return name.replace(/\.[^.]+$/, '.'+newExt); }
    function getOutputFileName(origName, outExt){
      let base = removeParamCheckbox.checked ? getCleanFileName(origName) : origName;
      return replaceExt(base, outExt);
    }

    function row(status, filePath, orig, target, result, note, previewURL, previewName){
      const div = document.createElement('div'); div.className = 'log-row';
      const badge = `<span class="badge ${status}">${status.toUpperCase()}</span>`;
      const nameHTML = previewURL
        ? `<a href="#" class="file-link" data-url="${previewURL}" data-name="${previewName||filePath}">${filePath}</a>`
        : `<span>${filePath}</span>`;
      div.innerHTML = `<div>${nameHTML}</div><div>${formatKB(orig)}</div><div>${formatKB(target)}</div><div>${formatKB(result)} ${badge}</div><div>${note||''}</div>`;
      logBody.appendChild(div);
      logBody.scrollTop = logBody.scrollHeight;
    }

    function dataURLToBlob(dataURL){
      const [header, base64] = dataURL.split(',');
      const mime = header.match(/:(.*?);/)[1];
      const binary = atob(base64);
      const array = Uint8Array.from(binary, c => c.charCodeAt(0));
      return new Blob([array], { type: mime });
    }

// è¾…åŠ©å‡½æ•°ï¼šå°† data URL è½¬æ¢ä¸º Blob
function dataURLToBlob(dataurl) {
  const arr = dataurl.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) {
    u8arr[n] = bstr.charCodeAt(n);
  }
  return new Blob([u8arr], { type: mime });
}

// è¾…åŠ©å‡½æ•°ï¼šè·å–æ–‡ä»¶æ‰©å±•å
function getFileExtension(filename) {
  return filename.split('.').pop().toLowerCase();
}

/**
 * ä½¿ç”¨äºŒåˆ†æ³•å°†å›¾åƒå‹ç¼©åˆ°ç›®æ ‡å¤§å°ã€‚
 * @param {File} file è¦å‹ç¼©çš„å›¾åƒæ–‡ä»¶ã€‚
 * @param {number} targetSize ç›®æ ‡å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚
 * @param {object} [options] å¯é€‰è®¾ç½®ã€‚
 * @param {boolean} [options.pngToJpg=false] æ˜¯å¦å°† PNG è½¬æ¢ä¸º JPGã€‚
 * @returns {Promise<{blob: Blob, outExt: string}>} ä¸€ä¸ª Promiseï¼Œè§£æä¸ºå‹ç¼©åçš„ Blob åŠå…¶æ‰©å±•åã€‚
 */
async function compressImageToTarget(file, targetSize, options = {}) {
  const { pngToJpg = false } = options;
  const img = new Image();
  const reader = new FileReader();

  reader.readAsDataURL(file);
  await new Promise(res => {
    reader.onload = () => {
      img.src = reader.result;
      img.onload = res;
    };
  });

  const canvas = document.createElement('canvas');
  canvas.width = img.width;
  canvas.height = img.height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0);

  const inExt = getFileExtension(file.name);
  let outMime = 'image/jpeg';
  let outExt = 'jpg';

  if (inExt === 'webp') {
    outMime = 'image/webp';
    outExt = 'webp';
  }
  if (inExt === 'png' && !pngToJpg) {
    outMime = 'image/png';
    outExt = 'png';
  }

  // å¦‚æœè¾“å‡ºæ ¼å¼ä¸º PNGï¼Œåˆ™æ— æ³•ä½¿ç”¨è´¨é‡å‚æ•°è¿›è¡Œå‹ç¼©ã€‚
  // æˆ‘ä»¬å°†ç›´æ¥è¿”å›é‡æ–°ç¼–ç çš„å›¾åƒã€‚
  if (outMime === 'image/png') {
    const dataUrl = canvas.toDataURL('image/png');
    const blob = dataURLToBlob(dataUrl);
    return {
      blob,
      outExt
    };
  }

  // å¯¹ JPG/WEBP å‹ç¼©ä½¿ç”¨äºŒåˆ†æ³•
  let low = 0.0;
  let high = 1.0;
  let bestBlob = null;
  let bestDiff = Infinity;

  // äºŒåˆ†æ³•æœç´¢é€»è¾‘ç°åœ¨æœ€å¤šè¿è¡Œ 10 æ¬¡ã€‚
  for (let i = 0; i < 10; i++) {
    const q = (low + high) / 2;
    const dataUrl = canvas.toDataURL(outMime, q);
    const blob = dataURLToBlob(dataUrl);
    const size = blob.size;

    // æˆ‘ä»¬å¯»æ‰¾å°äºæˆ–ç­‰äºç›®æ ‡å¤§å°çš„å°ºå¯¸ã€‚
    if (size <= targetSize) {
      bestBlob = blob;
      low = q;

      // æ£€æŸ¥æå‰é€€å‡ºæ¡ä»¶
      if (Math.abs(size - targetSize) <= targetSize * 0.1) {
        break; // å¦‚æœå¤§å°åœ¨ç›®æ ‡å€¼çš„ 10% ä»¥å†…ï¼Œåˆ™æå‰é€€å‡º
      }
    } else {
      high = q;
    }

    // å§‹ç»ˆè®°å½•ç›®å‰æ‰¾åˆ°çš„æœ€æ¥è¿‘çš„ blobï¼Œä»¥é˜²æˆ‘ä»¬è¶…å‡ºç›®æ ‡
    const diff = Math.abs(size - targetSize);
    if (diff < bestDiff) {
      bestDiff = diff;
      bestBlob = blob;
    }
  }

  // æœ€ç»ˆæ£€æŸ¥ï¼Œç¡®ä¿æˆ‘ä»¬è¿”å›çš„æ˜¯å°äºç­‰äºç›®æ ‡å¤§å°çš„æœ€ä½³ç»“æœã€‚
  // æˆ‘ä»¬ä½¿ç”¨ "low" å€¼å†å¾ªç¯ä¸€æ¬¡ï¼Œä»¥ç¡®ä¿å¾—åˆ°çš„ç»“æœ
  // å°äºæˆ–ç­‰äºç›®æ ‡å¤§å°ï¼ˆå¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªï¼‰ã€‚
  if (bestBlob && bestBlob.size > targetSize) {
    const finalDataUrl = canvas.toDataURL(outMime, low);
    const finalBlob = dataURLToBlob(finalDataUrl);
    if (finalBlob.size <= targetSize) {
      return { blob: finalBlob, outExt };
    }
  }

  return {
    blob: bestBlob,
    outExt
  };
}


    // ç»Ÿè®¡ç›®å½•å†…å›¾ç‰‡æ•°é‡
    async function countImageFiles(dirHandle) {
      let count = 0;
      for await (const entry of dirHandle.values()) {
        if (entry.kind === 'file' && isImageName(entry.name)) {
          count++;
        } else if (entry.kind === 'directory') {
          count += await countImageFiles(entry);
        }
      }
      return count;
    }

    function createZipAndDownload(name){ zip.generateAsync({type:'blob'}).then(b => saveAs(b, name)); }

async function processFileLike(readFile, writeBack, displayPath){
      const {file, name} = await readFile();
      if (!isImageName(name)) return;

      const target = getTargetSizeFromName(name);
      const pngToJpg = pngToJpgCheckbox.checked;
      const fileExt = ext(name);

      // é¢„è§ˆï¼ˆé»˜è®¤ç”¨åŸæ–‡ä»¶ï¼Œè‹¥ä¹‹åæœ‰å‹ç¼©ä¼šæ›¿æ¢ä¸ºæ–°blobï¼‰
      let previewURL = URL.createObjectURL(file);
      currentPreviewURLs.push(previewURL);
      let outName = name;
      let compressed, outExt, noteParts;

      // æ–°å¢é€»è¾‘: å¦‚æœæ˜¯PNGä¸”å‹¾é€‰äº†è½¬JPGï¼Œæ— è§†å¤§å°ç›´æ¥å‹ç¼©
      if (fileExt === 'png' && pngToJpg) {
        // ç›´æ¥æ‰§è¡Œå‹ç¼©å’Œè½¬æ¢
        ({ blob: compressed, outExt } = await compressImageToTarget(file, target, { pngToJpg }));
        noteParts = [`æ‰©å±•å ${fileExt}â†’${outExt}`];
      } else if (file.size <= target && !removeParamCheckbox.checked) {
        // å¦‚æœåŸå§‹æ–‡ä»¶å°äºç›®æ ‡ä¸”ä¸éœ€è¦æ”¹åï¼Œåˆ™ç›´æ¥è·³è¿‡
        row('skip', displayPath, file.size, target, file.size, 'åŸå§‹æ–‡ä»¶å°äºç›®æ ‡ï¼Œè·³è¿‡', previewURL, name);
        return;
      } else {
        // å¦åˆ™ï¼Œå°è¯•å‹ç¼©
        ({ blob: compressed, outExt } = await compressImageToTarget(file, target, { pngToJpg }));
        noteParts = [];
      }

      // å¤„ç†æ–‡ä»¶åä¿®æ”¹çš„æƒ…å†µ
      if (!compressed || compressed.size >= file.size) {
        // å¦‚æœå‹ç¼©å¤±è´¥æˆ–ç»“æœæ›´å¤§ï¼Œåˆ™ä»…ä¿®æ”¹æ–‡ä»¶åï¼ˆå¦‚æœå‹¾é€‰äº†ï¼‰
        if (removeParamCheckbox.checked) {
          const finalName = getOutputFileName(name, fileExt);
          outName = finalName;
          await writeBack(file, finalName);
          row('skip', displayPath, file.size, target, file.size, 'æœªå‹ç¼©ï¼Œä»…ä¿®æ”¹æ–‡ä»¶å', previewURL, finalName);
        } else {
          // å¦åˆ™ï¼Œè·³è¿‡å¤„ç†
          row('skip', displayPath, file.size, target, file.size, 'å‹ç¼©åæ›´å¤§ï¼Œè·³è¿‡', previewURL, name);
        }
        return;
      }

      // æ­£å¸¸å†™å›ï¼ˆå‹ç¼©æˆåŠŸï¼‰
      const finalName = getOutputFileName(name, outExt);
      outName = finalName;

      const resultURL = URL.createObjectURL(compressed);
      currentPreviewURLs.push(resultURL);
      previewURL = resultURL;

      await writeBack(compressed, finalName);

      noteParts.push(compressed.size > target ? 'å·²å‡å°ä½†æœªè¾¾ç›®æ ‡' : `å‹ç¼©ç‡ ${(100*(1 - compressed.size/file.size)).toFixed(1)}%`);
      row('ok', displayPath, file.size, target, compressed.size, noteParts.join('ï¼›'), previewURL, finalName);
    }

    // ç›®å½•æ¨¡å¼ï¼ˆè¦†ç›–ä¿å­˜ + å¯é‡å‘½å/æ”¹åç¼€ï¼‰
    async function chooseAndProcessDirectory(handle){
      try{
        if (!handle){
          if (!window.showDirectoryPicker){
            alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›®å½•è®¿é—®ï¼Œè¯·ä½¿ç”¨ Chrome/Edge æˆ–æ”¹ç”¨æ‹–æ‹½æ–‡ä»¶å‹ç¼©ä¸º ZIP ä¸‹è½½ã€‚');
            return;
          }
          handle = await showDirectoryPicker();
        }

        const imageCount = await countImageFiles(handle);
        if (imageCount === 0) { showToast('æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å¯å¤„ç†çš„å›¾ç‰‡ã€‚'); return; }

        const ok = imageCount >= 50
          ? await showCustomConfirm(`ğŸš¨ğŸš¨ğŸš¨ æ³¨æ„ï¼ğŸš¨ğŸš¨ğŸš¨\næ‚¨å·²æäº¤ ${imageCount} å¼ å›¾ç‰‡ï¼Œå³å°†è¦†ç›–å¤„ç†ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)
          : await showCustomConfirm(`æ˜¯å¦æ‰¹é‡å¤„ç†æ­¤æ–‡ä»¶å¤¹ä¸­çš„ ${imageCount} å¼ å›¾ç‰‡ï¼Ÿ\nå°†é€’å½’å¤„ç†å¹¶è¦†ç›–ä¿å­˜ã€‚`);
        if (!ok) return;

        resetLog();

        async function walk(dirHandle, prefix=''){
          for await (const [name, entry] of dirHandle.entries()){
            const path = prefix ? `${prefix}/${name}` : name;
            if (entry.kind === 'file'){
              await processFileLike(
                async () => ({ file: await entry.getFile(), name }),
                async (blob, suggestedName) => {
                  const intendedName = suggestedName || (removeParamCheckbox.checked ? getCleanFileName(name) : name);
                  if (intendedName !== name){
                    const newHandle = await dirHandle.getFileHandle(intendedName, { create: true });
                    const w = await newHandle.createWritable(); await w.write(blob); await w.close();
                    try { await dirHandle.removeEntry(name); } catch(e){}
                  } else {
                    const w = await entry.createWritable(); await w.write(blob); await w.close();
                  }
                },
                path
              );
            } else if (entry.kind === 'directory'){
              await walk(entry, path);
            }
          }
        }

        await walk(handle);
        showToast('ğŸ‰ å…¨éƒ¨å¤„ç†å®Œæˆï¼ˆæ–‡ä»¶å¤¹æ¨¡å¼ï¼‰');
      }catch(e){
        console.error(e);
        showToast('å¤„ç†å‡ºé”™ï¼š' + e.message);
      }
    }

    // æ–‡ä»¶æ¨¡å¼ï¼ˆæ‰“åŒ… ZIP ä¸‹è½½ï¼‰
    async function handleFilesToZip(files){
      zip.files = {}; // é‡ç½®ZIP
      resetLog();     // æ¸…ç©ºä¸Šæ¬¡æ—¥å¿—ï¼ˆæ»¡è¶³éœ€æ±‚#2ï¼‰
      let any = false;
      for (const file of files){
        const displayName = file.name;
        await processFileLike(
          async () => ({ file, name: file.name }),
          async (blob, suggestedName) => {
            any = true;
            const newName = suggestedName || (removeParamCheckbox.checked ? getCleanFileName(file.name) : file.name);
            const arrayBuffer = await blob.arrayBuffer();
            zip.file(newName, arrayBuffer, {date: new Date()});
          },
          displayName
        );
      }
      if (any){
        const now = new Date();
        const zipName = `compressed_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}-${String(now.getMinutes()).padStart(2,'0')}-${String(now.getSeconds()).padStart(2,'0')}.zip`;
        createZipAndDownload(zipName);
        showToast('ğŸ‰ å…¨éƒ¨å¤„ç†å®Œæˆï¼ˆå·²ç”Ÿæˆ ZIPï¼‰');
      } else {
        showToast('æœªå¤„ç†ä»»ä½•æ–‡ä»¶');
      }
    }

    // æ‹–æ‹½äº¤äº’ï¼ˆå•æ–‡ä»¶å¤¹æˆ–å¤šä¸ªæ–‡ä»¶ï¼‰
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', async e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');

      const items = e.dataTransfer.items;
      const files = e.dataTransfer.files;

      // å•æ–‡ä»¶å¤¹æ‹–å…¥ï¼ˆæ–°APIï¼‰
      if (items && items.length === 1){
        const item = items[0];
        if (item.getAsFileSystemHandle){
          try{
            const handle = await item.getAsFileSystemHandle();
            if (handle && handle.kind === 'directory'){
              await chooseAndProcessDirectory(handle);
              return;
            }
          }catch(err){}
        }
        // æ—§ webkit APIï¼ˆåªè¯»ï¼Œè½¬ZIPï¼‰
        if (item.webkitGetAsEntry){
          const entry = item.webkitGetAsEntry();
          if (entry && entry.isDirectory){
            showToast('æ£€æµ‹åˆ°æ–‡ä»¶å¤¹ï¼Œä½†æ— å†™å…¥æƒé™ï¼Œå°†è¯»å–åæ‰“åŒ…ä¸º ZIP ä¸‹è½½');
            const dirFiles = [];
            async function readDir(dir){
              const reader = dir.createReader();
              await new Promise(res => reader.readEntries(async entries => {
                for (const en of entries){
                  if (en.isFile){
                    await new Promise(r => en.file(f => { dirFiles.push(f); r(); }));
                  } else if (en.isDirectory){
                    await readDir(en);
                  }
                }
                res();
              }));
            }
            await readDir(entry);
            await handleFilesToZip(dirFiles);
            return;
          }
        }
      }

      // å¤šæ–‡ä»¶æˆ–éæ–‡ä»¶å¤¹
      if (files && files.length) {
        await handleFilesToZip(Array.from(files));
      }
    });

    // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ï¼ˆZIP æ¨¡å¼ï¼‰
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) handleFilesToZip(Array.from(fileInput.files));
    });

    // é€‰æ‹©ç›®å½•ï¼ˆè¦†ç›–ä¿å­˜æ¨¡å¼ï¼‰
    chooseDirBtn.addEventListener('click', async () => { await chooseAndProcessDirectory(null); });

    // ä¸»é¢˜åˆ‡æ¢ & è®°å¿†
    themeToggle.addEventListener('click', () => {
      const html = document.documentElement;
      html.dataset.theme = html.dataset.theme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', html.dataset.theme);
    });
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) document.documentElement.dataset.theme = savedTheme;
    else if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.dataset.theme = 'dark';

    // ç®€å•ç‰ˆæœ¬ç¼“å­˜æ¸…ç†
    const savedVersion = localStorage.getItem('appVersion');
    if (savedVersion !== APP_VERSION){
      if ('caches' in window){ caches.keys().then(names => names.forEach(n => caches.delete(n))); }
      localStorage.setItem('appVersion', APP_VERSION);
    }

    // ==== é¢„è§ˆäº¤äº’ï¼šhover å°å›¾ + click å¤§å›¾ ====
    function showPreviewAt(x, y, url){
      imgPreviewImg.src = url;
      const pad = 12;
      const vw = window.innerWidth, vh = window.innerHeight;
      const boxW = 200, boxH = 200;
      let left = x + 16, top = y + 16;
      if (left + boxW + pad > vw) left = x - boxW - 16;
      if (top + boxH + pad > vh) top = y - boxH - 16;
      imgPreview.style.transform = `translate(${left}px, ${top}px)`;
    }
    function hidePreview(){
      imgPreview.style.transform = 'translate(-9999px, -9999px)';
      imgPreviewImg.removeAttribute('src');
    }

    logBody.addEventListener('mousemove', (e)=>{
      const a = e.target.closest('.file-link');
      if (!a) return;
      showPreviewAt(e.clientX, e.clientY, a.dataset.url);
    });
    logBody.addEventListener('mouseleave', hidePreview);
    logBody.addEventListener('mouseover', (e)=>{
      const a = e.target.closest('.file-link');
      if (a) showPreviewAt(e.clientX, e.clientY, a.dataset.url);
    });
    logBody.addEventListener('mouseout', (e)=>{
      const a = e.target.closest('.file-link');
      if (a) hidePreview();
    });
    logBody.addEventListener('click', (e)=>{
      const a = e.target.closest('.file-link');
      if (!a) return;
      e.preventDefault();
      imgModalImg.src = a.dataset.url;
      imgModalName.textContent = a.dataset.name || '';
      imgModal.classList.add('show');
    });
    imgModalClose.addEventListener('click', ()=> imgModal.classList.remove('show'));
    imgModal.addEventListener('click', (e)=>{ if (e.target === imgModal) imgModal.classList.remove('show'); });
    window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') imgModal.classList.remove('show'); });
  </script>

  <!-- ç»Ÿè®¡è„šæœ¬ï¼ˆå¯é€‰ï¼‰ -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VZ52ZP6XCX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-VZ52ZP6XCX');
  </script>
  <script>
    var _hmt = _hmt || [];
    (function(){ var hm = document.createElement('script'); hm.src = 'https://hm.baidu.com/hm.js?ed5dc7380b880499808494b9cf6f0f48'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(hm, s); })();
  </script>

  <!-- è‡ªå®šä¹‰ç¡®è®¤å¼¹çª— -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal-content">
      <p id="modalText"></p>
      <div class="modal-buttons">
        <button id="modalCancelBtn" class="btn primary">å–æ¶ˆ</button>
        <button id="modalConfirmBtn" class="btn warning">ç»§ç»­å¤„ç†</button>
      </div>
    </div>
  </div>
</body>
</html>
